<style>.g_table .txt-user-chooser {width:6.5em;}</style><?php echo $this->renderElement('iteration_plan_nav',array('iteration_id'=>$current_iteration_id));?><h2 class="title"><span ><strong><?php echo t('Current Iteration','/iterations');?>:&nbsp;&nbsp;<?php echo $iteration['Iteration']['name']?>&nbsp;&nbsp;<label style="color:#006600;">(<?php echo $iteration['Iteration']['startdate']?>——<?php echo $iteration['Iteration']['enddate']?>)</label></strong></span></h2><?php $begin_date = $iteration['Iteration']['startdate']; $end_date = $iteration['Iteration']['enddate'];?><form id="assignment_form" method="POST" action="<?php echo $myHtml->url("/iterations/assignment")."/".$current_iteration_id; ?>"><div class="content"><div><?php if(!empty($stories_tasks)){ ?><table  class="g_table"><thead><tr><?php foreach($display_fields as $field):?><th <?php if(!empty($th_width[$field])) {echo "style='width:$th_width[$field];'";}?>><?php if($field <> 'Action'):?><?php$col_order_value = ($order_value == 'ASC')?'DESC':'ASC';$col_order_name = $field;$sort_url = $current_url."&order_name=$col_order_name&order_value=$col_order_value";?><a href="<?php echo $sort_url;?>"><?php echo $th_fieds[$field];if($order_name == $field)echo ($order_value == 'ASC')?' &uarr;':' &darr;';?></a><?php else:?><span><?php echo t($field);?></span><?php endif;?></th><?php endforeach;?></tr></thead><tbody><?php//debug($stories_tasks) ;/*组装表单校验的数组*/$field_valid = array(); foreach($stories_tasks as $obj):?><?php foreach($obj as $type => $object):?><?php $objid = $object['id'];  $objtype = strtolower($type);  $flag = true;?><tr <?php  if($objid == 'default'):echo 'id="default"';echo 'style="display:none;"';endif;if($objtype!='bug'){if(!empty($object['status']) && $this->controller->is_done($object['status'],$objtype)){  echo 'class="rowdone"';  }}else{if(isset($object['status'])&&(in_array($object['status'],get_bug_wf_ending_status())))echo 'class = "rowdone"' ;}?>><?php foreach($object as $key=>$value):?><?php if(in_array($key,$display_fields)):?><td <?php if($key=='name'): echo 'class="normal"';echo 'title="'.$value.'"';endif; echo 'field="'.$key.'"'?>><?php if(in_array($objtype.'_'.$objid,$son_objects) && $flag || ($objid == 'default' && $flag)):$flag = false;?>&nbsp;&nbsp;<?php //此处做是否是叶子节点的判断仅是为了灵活性，迭代规划中的需求目前必定是叶子需求，逻辑可以更简化的if ($objtype=="story"){ $story_tag_name = "tag_story_child";$tip = $myHtml->tip_translate(1); ?><span class="tapd-tips <?php echo $story_tag_name?>" title="<?php echo t($tip['content']).'<br/>(tip_code:'.$tip['code'].')' ?>"><i><?php echo $objtype;?></i></span><?php }else { ?><span class="tag_<?php echo $objtype;?>"><i><?php echo $objtype;?></i></span><?php } ?> <?php elseif($flag):$flag = false;?><?php //此处做是否是叶子节点的判断仅是为了灵活性，迭代规划中的需求目前必定是叶子需求，逻辑可以更简化的if ($objtype=="story"){ $story_tag_name = "tag_story_child";$tip = $myHtml->tip_translate(1); ?><span class="tapd-tips <?php echo $story_tag_name?>" title="<?php echo t($tip['content']).'<br/>(tip_code:'.$tip['code'].')' ?>"><i><?php echo $objtype;?></i></span><?php }else { ?><span class="tag_<?php echo $objtype;?>"><i><?php echo $objtype;?></i></span><?php } ?> <?php endif;?><?php if( !empty($fields_info) && array_key_exists($key,$fields_info[$objtype])):?><?php $show_type = 0;?><?php if( array_key_exists('linkable',$fields_info[$objtype][$key]) ) : $show_type += LINK_TYPE; endif;?><?php if(array_key_exists('dropable',$fields_info[$objtype][$key])): $show_type += DROP_TYPE; endif;?><?php if(array_key_exists('userchooser',$fields_info[$objtype][$key])): $show_type += USERCHOOSER_TYPE; endif;?><?php if(array_key_exists('dateinput',$fields_info[$objtype][$key])): $show_type += DATEIPUT_TYPE; endif;?><?php $tmp_fields_info = $fields_info;?><?php if ( LINK_TYPE == $show_type ):?><?php $this->controller->__replace_field_value($tmp_fields_info[$objtype],$objid,$key,'linkable');?><?php $url = $tmp_fields_info[$objtype][$key]['linkable'];?><?php if($objid == 'default' && $key== 'name'):?><input type="text" name="data[Workitem][<?php echo $key?>]" value="<?php echo $value;?>" style="width:12em;"><?php else:?><a href="<?php echo $myHtml->url($url);?>" <?php if('bug'==$objtype) echo "target='_blank'"  ?> ><?php echo $value;?></a><?php endif;?><?php elseif ( DROP_TYPE == $show_type ):?><?php $this->controller->__replace_field_value($tmp_fields_info[$objtype],$objid,$key,'dropable');?><?php $dropable = $tmp_fields_info[$objtype][$key]['dropable'];?><?php $default = $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id']);?><?php echo $this->renderElement('pop_select',array('id'=>$objtype.'_'.$key.'_'.$objid,'default'=>$default,'url'=>$dropable['url'],'options'=>$dropable['options'],'is_asy'=>$dropable['is_asy']));?><?php elseif ( USERCHOOSER_TYPE == $show_type ):?><?php if($objid == 'default' && ($key== 'owner')):?><input type="hidden"  userchooser="true" value="" /><input type="text" style="width:12.5em;" value="joeyue" autocomplete="on" /><?php else:?><div><?php if($objtype=='bug')$item_name = $objid.'_'.$key.'_bug' ;else $item_name = $objid.'_'.$key ; ?><?php echo $top->userChooser('Workitem/'.$item_name,1,array('value'=>$value));?></div><?php endif;?><?php elseif ( DATEIPUT_TYPE == $show_type ):?><div><?php echo $myHtml->dateinput('Workitem/'.$objid.'_'.$key,array("style"=>'width:6.25em','begin'=>$begin_date,'end'=>$end_date,'value'=>empty($value)?'':$value));?></div><?php if($objid != 'default'):$field_valid = array_merge($field_valid,array("Workitem".$objid.ucfirst($key) => array("name" => $key, "enabled" => "1", "notnull" => "0", "label" => t($key, "/iteration") ,"html_type" => "dateinput")));?><div id="<?php echo "Workitem".$objid.ucfirst($key);?>Tip" class="error_tip"></div><?php endif;?><?php else:?><?php echo $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id']);?><?php endif;?><?php elseif($key == 'Action'):?><?php if($objtype == 'story'):?><a title = "<?php echo t('Add Task','/prong') ; ?>" class="tapd-btn-add-task" onclick="split_task(this);" story_id = "<?php echo $objid;?>" task_count=100><i><?php echo t('Add Task','/stories');?></i></a><?php elseif($objid == 'default'):?><a title = "<?php echo t('Delete') ; ?>" class = "tapd-btn-del" onclick="javascript:$(this).parent().parent().remove();"><i><?php echo t('Remove','/iterations');?></i></a><?php else:?>&nbsp;&nbsp;&nbsp;&nbsp;<?php endif;?><?php else: ?><?php if($key == 'effort' && in_array($objtype,$measurement_types)):?><input type="text" name="data[Workitem][<?php echo $objid.'_'.$key?>]" value="<?php echo $value;?>" style="width:4em;"><?php elseif($objtype=='story' && in_array($key,array('business_value','size','tech_risk'))):?><input type="text" name="data[Workitem][<?php echo $objid.'_'.$key?>]" value="<?php echo $value;?>" style="width:4em;"><?php else:?><?php echo $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id']);?><?php endif;?><?php endif;?></td><?php endif;?><?php endforeach;?></tr><?php endforeach;?><?php endforeach;?></tbody></table><?php  echo $this->renderElement('pager'); ?><?php }else{ ?><?php echo t('No Data', '/prong') ?><?php } ?></div></div><?php echo $this->renderElement('edit_button',array('url'=>$myHtml->url('/iterations'),'isSaveView'=>true,'isCanelInIteration'=>true,)) ?></form><?php echo $this->renderElement('helper_footer',array('name'=>'IterationHelp','sub_name'=>''));?><?php//组装表单校验的数组if(!empty($field_valid)){//生产表单校验js代码 author:emilyzhang 2009-06-05echo $this->renderElement('form_validator',array("formid"=>"assignment_form","object"=>"Workitem","valid_infor"=>$field_valid));}?><?php echo $javascript->link('pop_select');?><?php echo $javascript->link('iterations_assignment');?><script type="text/javascript">$(document).ready(function(){checkSave('assignment_form');});/***验证页面是否保存monitorObjects 监控需要保存的标签名,如果这些标签发生改变,则触发保存确认框monitorObjects = =new Array("input","checkbox");*kuncai**/function checkSave(formID){var ISNEEDSAVE = false; $("#assignment_form input").change(function(){ISNEEDSAVE = true;});$("input.button").click(function(){ISNEEDSAVE = false;});$("#assignment_form .calendar").click(function(){ISNEEDSAVE = true;});$("#assignment_form .creat_task").click(function(){ISNEEDSAVE = true;});$("#iteration_plan_nav a").click(function(){if(ISNEEDSAVE){ISNEEDSAVE = false;if(confirm("是否保存")){var action = $("#"+formID).attr('action');var href = $(this).attr('href');$("#"+formID).attr('action',action+"?save=true&ref="+href)$("#"+formID).submit();return false;}}return true;});window.onbeforeunload = function(){if(ISNEEDSAVE){return "表单未保存,离开页面将丢失数据!";}};}//var check_date_error_msg = "<?php echo t('The date is not in the iteration','/iterations');?>";</script>
