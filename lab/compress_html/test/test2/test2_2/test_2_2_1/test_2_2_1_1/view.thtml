<?php/*** bbs帖子查看页面* @param comment_id * @param $comments 帖子的数据* @param $current_user 当前用户*  * @package View.Comment* @author kuncai*/?><?php echo $html->css('comment') ?><div class="comments"><?php $i=0;foreach($comments as $obj):foreach($obj as $comment):if($comment['created_by'] == current_user('nick') || !empty($this->viewVars['system_admin']) || !empty($this->viewVars['project_admin']) ) {//fix delete comment redirect bug. frankyif($project['id'] == 0){$edit_url =BASE_PATH.'comments/edit/'.$comment['id'];if($i == 0){$edit_url =BASE_PATH.'comments/edit/'.$comment['id'].'?post=ture';$del_url = BASE_PATH.'comments/delete/'.$comment['id'].'?post=true';}else{$del_url = BASE_PATH.'comments/delete/'.$comment['id'].'?ref=/'.urlencode($this->params['url']['url']).'&post_id='.$comments[0]['Post']['id'];}} else {$edit_url = BASE_PATH.$project_code.'/comments/edit/'.$comment['id'];if($i == 0){$edit_url =BASE_PATH.$project_code.'/comments/edit/'.$comment['id'].'?post=true';$del_url = BASE_PATH.$project_code.'/comments/delete/'.$comment['id'].'?post=true';}else{$del_url = BASE_PATH.$project_code.'/comments/delete/'.$comment['id'].'?ref=/'.urlencode($this->params['url']['url']).'&post_id='.$comments[0]['Post']['id'];}} }?><?php $taotao_url = TAOTAO_ROOT . "users/profile/".$comment['created_by'];?><div class="comment_row"><?php if($i == 0):?><div class="main_tp"><form style="display: inline" id="richreply" action="<?php if($project['id'] != 0) echo$html->url('/'.$project_code.'/comments/reply/'.$comment['id']);elseecho$html->url('/comments/reply/'.$comment['id']);?>";><input id="desc" type="hidden" name="Comment[title]" value="" /></form><table class="topic"><tr><td><?php echo UserClient::avatar($comment['created_by']); ?></td><td class="user_info" width="100%"> <div class="title"><?php echo $comment['title'];?><?php if (isset($project_names) ){?><?php }?></div><div class="more"><?php echo $comment['created_by'];?><?php echo t('Post at')?><?php if(!empty($project_names)):?><span class="workspace_name"><?php echo $html->link( $project_names['name'], '../'.$project_names['pretty_name'].'/comments/',array('target' => 'main')); ?></span><?php endif ?><span class="post_at"><?php echo ago($comment['created'])?></span><span class="reply_count"><?php echo $comment['reply_count'];?> <?php echo t("Reply ")?></span><span class="read_count"><?php echo $comment['read_count'];?> <?php echo t("Read")?></span></div></td></tr></table></div><?php else: ?><div class="sub_tp"><h3 id="<?php echo $comment['id'] ?>"><span id="floor"><?php echo '#'.($i).' ';?></span> :<a href="<?php echo $taotao_url?>" target="_parent"><?php echo $comment['created_by'];?></a>&nbsp;<span class="post_at"><?php echo t('Post at')?> <?php echo ago($comment['created'])?></span><?php if($comment['created_by'] == current_user('nick') ){echo $html->link($html->image('edit2-c.gif',array("onmouseover"=>"javascript:mouse_over_button(this);","onmouseout"=>"javascript:mouse_out_button(this);")),$edit_url,array('title' =>t('edit','/bbs')),false,false);echo " &nbsp; ";echo $html->link($html->image('x.gif',array("onmouseover"=>"javascript:mouse_over_button(this);","onmouseout"=>"javascript:mouse_out_button(this);")),$del_url,array('title' =>t('delete','/bbs'),"onclick"=>"javascript:return confirm('".t('Sure to delete','/bbs')."？');"),false,false);}?></h3></div><?php endif ?><div class="content"><?php echo $comment['content']; ?></div><!-- 列举主题的附件信息 --><?php if($i == 0 ):?><?php if(isset($comment_attachments) && !empty($comment_attachments) ):?><div class="attachment_list"><?php echo $this->renderElement('attachment_list', array('attachments'=>$comment_attachments)); ?></div><?php endif ?><div class="actions"><?php if($comment['created_by'] == current_user('nick')){echo $html->link(t("Edit"),$edit_url,array('title' =>t('Edit')),false,false);echo " | ";echo $html->link(t("Delete"),$del_url,array('title' =>t('Delete'),"onclick"=>"javascript:return confirm('".t('Sure to delete','/bbs')."？');"),false,false);}?><?php if(!empty($project['id'])):?><?php if(!empty($this->viewVars['system_admin']) || !empty($this->viewVars['project_admin'])):?>| <a href="<?php echo $html->url("/$project_code/comments/top/".$comment['id'])?>"><?php echo t($isTop?'undoTop':'Top')?></a><?php endif ?><?php if(!empty($this->viewVars['system_admin']) || !empty($this->viewVars['project_admin'])):?>| <a href="<?php echo $html->url("/$project_code/comments/essential/".$comment['id'])?>"><?php echo t( $isEssential?'undoEssential':'Essential')?></a><?php endif ?><?php endif ?><?php if (!empty($perms['Attachments::add']) && ($comment['author']==$current_user)) {?>| <a href="<?php echo $myHtml->url("/attachments/add/comment/".$comment_id.'?layout=none'); ?>"><?php echo t('Attach File','/bbs') ?></a><?php }?></div><?php endif ?><p></p><div class="fixed">&nbsp;</div></div><?php if($i == 0 ){$post = $comment;}$i++;endforeach; endforeach;?><div id="quick_comment" class="quick_comment" <?php if(empty($reply_type) || $reply_type<>'rich_reply'):echo 'style="display:block;"';else: echo 'style="display:none;"';endif;?> ><form method="post" action="<?php echo $myHtml->url("/comments/reply/".$post['id']);?>"><label for="comment"><?php echo t('Quick Reply','/comments')?>:</label><a onclick="show_reply('rich_reply');">【<?php echo t('Rich Reply','/comments')?>】</a><br></br>   <input type="hidden" name="data[Comment][title]" value="<?php echo 're:'.$post['title']?>" />   <?php echo $html->textarea('Comment/content', array('class'=>'wikitext', 'rows'=>5, 'cols'=>80, 'style'=>"width:760px")); ?><div class="actions">  <?php echo $html->submit(t('Quick comment'),array('class'=>"tapd-button")) ?><span class="notice_all_checkbox"><input style="vertical-align:middle" id="notice_all" type="checkbox" style="padding:5px" name="data[Comment][notice_all]" title=<?php echo t('Remind All Participators')?>/><label for="notice_all" style="vertical-align:middle;"><?php echo t('Remind All Participators') ?></label></span></div><input type="hidden" name="data[Message][rtx]" value="rtx" /></form></div><div id="dzh_newcomment" style="display:none;margin-top:25px;"><?php echo $myHtml->formTag('/comments/reply/'.$post['id']);?><label for="comment"><?php echo t('Rich Reply','/comments')?>:</label><a onclick="show_reply('quick_reply');">【<?php echo t('Quick Reply','/comments')?>】</a><br></br><div class="textfield"><?php echo $this->renderElement('richeditor', array('id'=>'Comment/content','emotion_amount'=>41, 'value'=>empty($this->params['url']['Comment']['description'])?'':$this->params['url']['Comment']['description']))?><?php echo $html->tagErrorMsg('Comment/content', 'Description is required.') ?></div><div style="padding:6px 0px;"><?php echo $html->submit(t('Save'), array('class'=>"tapd-button"));?>&nbsp;<a onclick="javascript:history.go(-1);return false;"><?php echo t('Cancel') ?></a><span class="notice_all_checkbox"><input style="vertical-align:middle" id="notice_all" type="checkbox" style="padding:5px" name="data[Comment][notice_all]" title="提醒主题所有参与人" /><label for="notice_all"><?php echo t('Remind All Participators'); ?></label></span></div><?php echo $this->renderElement('message_form',array('width'=>'98%','isset_group_on'=>'off'))?></form></div></div><script>function show_reply(reply_type){if(reply_type == 'rich_reply'){$('#quick_comment').css('display','none');$('#dzh_newcomment').css('display','block');}else{$('#dzh_newcomment').css('display','none');$('#quick_comment').css('display','block');}}$(document).ready(function(){$('.commandlist').change(function(){var option = this.options[this.selectedIndex];if ($(option).attr('confirm') == 'true')if (!confirm('<?php echo t('Are you sure?') ?>')) return;if (option.value && option.className!="parent") {document.location.href = option.value;}else if(window.parent){window.parent.document.location.href = option.value;}});<?php if(isset($this->params['url']['reload'])) : ?>if(window.parent){window.parent.document.getElementById('frm_subjects').src= window.parent.document.getElementById('frm_subjects').src + '&<?php echo time() ?>';}<?php endif ?>IFrameResize();}); $('.richcomment_link').click( function(){ $("#richreply").submit(); return false;} );$('#richreply').submit( function(){ //$('#desc').val($('.wikitext').attr("value").replace(/\n/g,'</br>'));});function mouse_over_button(obj){obj.style.border = "solid 1px #aad5ef";}function mouse_out_button(obj){obj.style.border = "none";} function IFrameResize() {  <?php if(!preg_match('/Firefox/',$_SERVER['HTTP_USER_AGENT'])): ?>var obj = parent.document.getElementById("frm_contents");var height = this.document.body.scrollHeight; if(height > 800){ obj.height = this.document.body.scrollHeight; } <?php endif; ?> } </script>
