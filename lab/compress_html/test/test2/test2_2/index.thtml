<?php echo $html->css('jquery.cluetip');?><style>.iteration_title a{ padding-right:5px;}.g_table_active .iteration_title a{ font-size:14px;font-weight:600;}</style><div class="tapd-toolbar"><button class="tapd-button" onclick="window.location.href='<?php echo $myHtml->url("/iterations/edit");?>'" id="add" title="<?php echo t('Add Iteration','/prong')?>"><?php echo t('Add Iteration','/prong')?></button><?php if (empty($iteration_count)) : ?><span class="secondary"><?php echo t('Export View');?></span><?php else : ?><?php  echo $this->renderElement('export');?><?php  endif; ?></div><div class="content"><form method="GET" id="select_object" action="" style="margin-bottom:10px;"><?php format_url($this->controller->params['url'],'',array('page','show_story','show_task','show_bug')); ?><div class="tapd-action" style="float:left"> <?php echo $this->renderElement('customview');?><!-- 快捷过滤 --><span class="" id="shortcut_filter" ><span style="margin-left:10px;"><?php echo t('module'); ?>:<select name="data[Shortcut_filter][module]" onchange="submit_form('select_object')" <?php if(!in_array('story',$show_types)) echo 'disabled=disabled';?> title="可以输入首字母快速定位"><?php foreach($modules as $key=>$value){ ?><option value="<?php echo $key; ?>" <?php if(isset($shortcut_filter_module)&&$shortcut_filter_module==$key)echo 'SELECTED=selected' ?>><?php echo $value; ?></option><?php } ?></select></span><span style="margin-left:10px;"><?php echo t('owner'); ?>:<select id="select_owner" name="data[Shortcut_filter][owner]" onchange="submit_form('select_object')" title="|输入首字母快速定位"><?php $flag=FALSE;?><?php foreach($owners as $group){ ?><?php if($flag){?><optgroup label="<?php echo '-------------';?>"><?php foreach($group as $key=>$value){?><option value="<?php echo $key; ?>" <?php if(isset($shortcut_filter_owner)&&$shortcut_filter_owner==$key)echo 'SELECTED=TRUE' ?>><?php echo $value; ?></option><?php }?></optgroup><?php }else{?><?php $flag=TRUE;?><?php foreach($group as $key=>$value){?><option value="<?php echo $key; ?>" <?php if(isset($shortcut_filter_owner)&&$shortcut_filter_owner==$key)echo 'SELECTED=TRUE' ?>><?php echo $value; ?></option><?php }?><?php }?><?php } ?></select></span></span><!-- end 快捷过滤 --></div><?php //if(count($set_types) > 1)://有多个实体才出现checkbox，一个的话就没必要了?><div class="tapd-action" style="float:right"> <?php if(in_array('story',$set_types)):?><input type="checkbox" name="show_story" value="story" onclick="submit_form('select_object')" <?php if(in_array('story',$show_types)) echo 'checked';?> ><?php echo t('Show Story','/iterations');?>&nbsp;&nbsp;<?php endif;?><?php if(in_array('task',$set_types)):?><input type="checkbox" name="show_task" value="task" onclick="submit_form('select_object')" <?php if(in_array('task',$show_types)) echo 'checked';?> ><?php echo t('Show Task','/iterations');?>&nbsp;&nbsp;<?php endif;?><?php if(in_array('bug',$set_types)):?><input type="checkbox" name="show_bug" value="bug" onclick="submit_form('select_object')" <?php if(in_array('bug',$show_types)) echo 'checked';?> ><?php echo t('Show Bug','/iterations');?><?php endif;?></div> <?php //endif;?><!--暂时去掉高级过滤 <span id="filter_button" style=""><a onclick="click_filter()" style="margin:0;"><?php echo t("filter","/tapd"); ?></a><span ><?php echo '&darr;' ?></span></span> --></form><div class="fixed"></div><div><?php foreach($iteration_list as $iteration): $iteration_id = $iteration['Iteration']['id'];//过滤条件,'and'=>$condition_filter$story_condition = array("iteration_id"=>$iteration_id);$task_condition = array("iteration_id"=>$iteration_id);$bug_condition = array("iteration_id"=>$iteration_id);if(!empty($condition_filter)){$story_condition['and']=$condition_filter['Story'] ;$task_condition['and']=$condition_filter['Task'] ;$bug_condition['and']=$condition_filter['Bug'] ;}$story_condition_url = _convert_urlArray_to_urlString($story_condition,'story_conditions') ;$task_condition_url = _convert_urlArray_to_urlString($task_condition,'task_conditions') ;$bug_condition_url = _convert_urlArray_to_urlString($bug_condition,'bug_conditions') ;$types = array('types'=>$show_types);$types = _convert_urlArray_to_urlString($types);$fields= array('fields'=>$show_fields);$fields = _convert_urlArray_to_urlString($fields);$link_url = BASE_PATH . $workspace['pretty_name'] . DS . 'prong/iterations/iteration_stories_tasks?iteration_id=' . $iteration_id . '&' . $story_condition_url . '&' . $task_condition_url . '&' . $bug_condition_url . '&'. $types .'&limit=30' . '&'. $fields;$tmp_fields_info = $fields_info;$story_task_count = $iteration_static_info[$iteration_id]['story_total'] + $iteration_static_info[$iteration_id]['task_total'] + $iteration_static_info[$iteration_id]['bug_total'] ;?><div id="<?php echo 'iteration_table_',$iteration_id,'_wrapper';?>" <?php if(in_array($iteration_id,$current_iteration)&&($story_task_count > 0)) echo 'class="g_table_active"';?>><table class="g_table"><tr><td width="22" style="padding-top:4;padding-right:0;padding-bottom:0;padding-left:0;"><?php if($story_task_count > 0) :?><a style="" class="<?php echo (in_array($iteration_id,$current_iteration) && empty($fold) ) ?'fold':'unfold';?>" <?php if(in_array($iteration_id,$current_iteration) && empty($fold)) echo "is_loaded='1'";?> onclick="load_iteration(this,'<?php echo 'iteration_table_'.$iteration_id ;?>','<?php echo str_replace("'","YYYYY",str_replace("\"","XXXXX",$link_url));?>')"><i>foldsign</i></a><?php else:?><?php endif;?></td><td><span class="iteration_title"><a href="<?php echo $myHtml->url('/iterations/view/'.$iteration_id);?>" title="<?php echo t('View Iteration','/iterations');?>"><?php echo $iteration['Iteration']['name'];?></a></span><span style="padding:0 5px;">-</span><span class="secondary">(<?php echo t('from','/iterations');echo '&nbsp;';echo date($iteration['Iteration']['startdate']); echo '&nbsp;';echo t('to','/iterations'); echo '&nbsp;';echo date($iteration['Iteration']['enddate']);?>)<?php echo t('Iteration Progress','/iterations').':';?><strong style="padding:0 5px;"><?php echo ($iteration_static_info[$iteration_id]['story_done'] + $iteration_static_info[$iteration_id]['task_done'] + $iteration_static_info[$iteration_id]['bug_done']).'/'.($iteration_static_info[$iteration_id]['story_total'] + $iteration_static_info[$iteration_id]['task_total'] + $iteration_static_info[$iteration_id]['bug_total']);?></strong></span></td><td width="120"><?php $this->controller->__replace_field_value($tmp_fields_info['iteration'],$iteration_id,'Action','dropable');?><?php $dropable = $tmp_fields_info['iteration']['Action']['dropable'] ?><?php if($iteration['Iteration']['status']=='open'){ ?><?php $dropable['options']['close']= t('Close','/iterations'); ?><?php $dropable['url']['close']= $myHtml->url('/iterations/changeStatus'.'?objid='.$iteration_id.'&new_status=done'); ?><?php }else{ ?><?php $dropable['options']['open']= t('Open','/iterations'); ?><?php $dropable['url']['open']= $myHtml->url('/iterations/changeStatus'.'?objid='.$iteration_id.'&new_status=open'); ?><?php } ?><span class="action" style = "float:right;padding-right:10px"><a title = "<?php echo t('Planning') ; ?>" class = "tapd-btn-planning" href = "<?php echo $myHtml->url('/iterations/edit/'.$iteration_id) ; ?>"><i><?php echo t('Planning') ; ?></i></a><?php if(in_array('task',$set_types)):?><a title = "<?php echo t('Add Task') ; ?>" class="tapd-btn-add-task" href="<?php echo $myHtml->url('/tasks/add?iteration_id='.$iteration_id) ; ?>"><i><?php echo t('Add Task') ; ?></i></a><?php endif;?><?php $this->controller->__replace_field_value($tmp_fields_info['iteration'],$iteration_id,'Action','dropable');?><?php $dropable = $tmp_fields_info['iteration']['Action']['dropable'] ?><?php if($iteration['Iteration']['status']=='open'){ ?><a class="tapd-btn-close" title="<?php echo t('Close Iteration') ; ?>" href = "<?php echo $myHtml->url('/iterations/changeStatus?objid='.$iteration_id.'&new_status=done') ; ?>"><i><?php echo t('Close Iteration') ; ?></i></a><?php //$dropable['options']['close']= t('Close','/iterations'); ?><?php //$dropable['url']['close']= $myHtml->url('/iterations/changeStatus'.'?objid='.$iteration_id.'&new_status=done'); ?><?php }else{ ?><a class="tapd-btn-open" title = "<?php echo t('Open Iteration') ; ?>" href="<?php echo $myHtml->url('/iterations/changeStatus?objid='.$iteration_id.'&new_status=open') ; ?>"><i><?php echo t('Open Iteration') ; ?></i></a><?php //$dropable['options']['open']= t('Open','/iterations'); ?><?php //$dropable['url']['open']= $myHtml->url('/iterations/changeStatus'.'?objid='.$iteration_id.'&new_status=open'); ?><?php } ?><?php //echo $this->renderElement('pop_select',array('id'=>'iteration_'.$iteration_id.'_pop_select','default'=>t('More Action','/prong'),'url'=>$dropable['url'],'options'=>$dropable['options'],'is_asy'=>$dropable['is_asy'], 'iteration_id' => $iteration_id));?></span></td></tr></table><?php if(($iteration_static_info[$iteration_id]['story_total'] + $iteration_static_info[$iteration_id]['task_total'] + $iteration_static_info[$iteration_id]['bug_total'] ) > 0):?><div url="<?php echo str_replace("'","YYYYY",str_replace("\"","XXXXX",$link_url));?>" class="iteration_table content" id="<?php echo 'iteration_table_'.$iteration_id;?>" <?php if(!in_array($iteration_id,$current_iteration) || !empty($fold)) echo 'style="display:none;"';?>><?php if(in_array($iteration_id,$current_iteration) && empty($fold) ):$pretty_name = $this->_viewVars['workspace']['pretty_name'];$render_action = "/$pretty_name/prong/iterations/iteration_stories_tasks/iteration_id=". $iteration_id . '&' . $story_condition_url . '&' . $task_condition_url . '&' . $bug_condition_url . '&' . $types . '&' . $fields . '&limit=30';echo $this->controller->requestAction($render_action,array('return'));else:echo t('Loading...','iterations');endif;?></div><?php endif;?></div><?phpendforeach;?></div></div><?php echo $this->renderElement('helper_footer',array('name'=>'IterationHelp','sub_name'=>''));?><?php echo $this->renderElement('pager'); ?><?php echo $myJavascript->link('pop_select',array('loader'=>'loadJsFile'),1000);?><?php echo $myJavascript->link('asy_page_sort_iteration_list',array('loader'=>'loadJsFile'),500);?><?php echo $myJavascript->link('task',array('loader'=>'loadJsFile'),500);?><?php echo $javascript->link('jquery.cluetip');?><script>$(document).ready(function(){$('#select_owner').cluetip({  splitTitle: '|',   arrows: true,   dropShadow: true,   showTitle: false,  width:'150px',  topOffset:'-30px',  leftOffset:'-120px',  positionBy: 'fixed',  cluetipClass: 'jtip'});});var currentUser = "<?php echo current_user('nick');?>";var workspaceId = <?php echo $this->controller->workspace['id']?>;function click_filter(){$('#tapd_filter_panel').toggle();if($('#tapd_filter_panel').is(":hidden")){$("#filter_button span").html("&darr;");//'&uarr;':}else{$("#filter_button span").html("&uarr;");}}function show_iterations(object,show_id){var class_name = $(object).attr('class');if(class_name == 'fold'){$('#'+show_id).css('display','none');$(object).attr('class','unfold');}else{$('#'+show_id).css('display','block');$(object).attr('class','fold');}}function load_iteration(obj,parent_id,url){//加上时间,防止缓存var date = new Date();var time_now = date.getTime();url += "&time="+time_now;if($(obj).attr('is_loaded')){//alert('ggggg') ;if($(obj).attr('class') == 'fold'){$('#'+parent_id).css('display','none');$('#'+parent_id+'_wrapper').removeClass("g_table_active");$(obj).attr('class','unfold');}else{$('#'+parent_id).css('display','block');$('#'+parent_id+'_wrapper').addClass("g_table_active");$(obj).attr('class','fold');}}else{var re = /XXXXX/g;url = url.replace(re,'"');re = /YYYYY/g;url = url.replace(re,"'");$('#'+parent_id).css('display','block');$('#'+parent_id).load(url);$('#'+parent_id).show();$('#'+parent_id+'_wrapper').addClass("g_table_active");$(obj).attr('class','fold');$(obj).attr('is_loaded','1');}}function refresh_iteration(iteration_id){var url = $('#iteration_table_'+iteration_id).attr('url');var re = /XXXXX/g;url = url.replace(re,'"');re = /YYYYY/g;url = url.replace(re,"'");$('#iteration_table_'+iteration_id).load(url);}function submit_form(form_id){$('#'+form_id).submit();}function showResponse(responseText, statusText,iteration_table_id){ var iteration_table = $('#'+iteration_table_id)var url = $(iteration_table).attr('url');var time = new Date();var re = /XXXXX/g;url = url.replace(re,'"');re = /YYYYY/g;url = url.replace(re,"'");$(iteration_table).load(url + "&" + time.getTime());} //fix bug:2703711function mychange(obj,p_id){var iteration_id = $(obj).parent().parent().parent().parent().parent().parent().attr('id');iteration_id = iteration_id.replace('iteration_table_','');change_task_status(obj, p_id, {confirm_msg: "<?php echo t('There is some effort remained.If you click yes,the remain effort will be added automatically.'); ?>",     success_msg: "<?php echo t("Successful!") ?>",     failure_msg: "<?php echo t("Failed!") ?>"});refresh_iteration(iteration_id);}</script>
