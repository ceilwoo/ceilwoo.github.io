<!-- Stories --><?php //debug($fields_info) ; ?><?php if(!empty($operation_list['story']['timesheet'])){$operation_list['story']['timesheet']['url'] = sprintf($operation_list['story']['timesheet']['url'],'callback=self.parent.refresh_iteration(314)');}if(!empty($operation_list['task']['timesheet'])){$operation_list['task']['timesheet']['url'] = sprintf($operation_list['task']['timesheet']['url'],"callback=self.parent.refresh_iteration($iteration_id)");}?><?php if(!empty($stories_tasks)){ ?><table  class="g_table"><thead><tr><?php foreach($display_fields as $field):?><!-- 确定宽度 --><?php$width = "auto" ;switch($field){//for bugcase 'title':$width = 'auto' ;break;//end for bugcase 'id':$width = "100" ;break;case 'name':$width = "auto" ;break;case 'priority':$width = "80" ;break;case 'status':$width = "60" ;break;case 'creator':case 'cc':case 'owner':$width = "80" ;break;case 'iteration_id':case 'release_id':$width = "200" ;break;case 'created':$width = '100';break;case 'completed':case 'modified':case 'begin':case 'due':$width = "60" ;break;case 'effort':case 'effort_completed':case 'exceed':case 'remain':$width = "50" ;break;case 'size':$width = '30' ;break;case 'business_value':$width = '50' ;break;case 'progress':$width = "85" ;break;case 'Action':$width = "60" ;break;default:$width = "80" ;break;}?><th width = "<?php echo $width ;?>"><?php if($field <> 'Action'):?><a style="cursor:pointer" onclick="load_url(<?php echo '\''.'iteration_table_'.$iteration_id.'\'';?>,'<?php echo str_replace("'","YYYYY",str_replace("\"","XXXXX",$current_url));?>', '<?php echo $field;?>', '<?php echo (isset($order) && strtolower($order)== 'asc')?'desc':'asc'; ?>');"><?php if(array_key_exists($field,$system_fields_name)):echo $system_fields_name[$field];else:echo t($field,'/iterations');endif;?><?php if( isset($order) && $sort_name == $field ){  echo (strtolower($order) == 'asc')?' &uarr;':' &darr;'; }?></a><?php else:echo $system_fields_name[$field]; endif;?></th><?php endforeach;?></tr></thead><tbody><?php foreach($stories_tasks as $obj):?><?php foreach($obj as $type => $object):?><?php   $objtype = strtolower($type);  $objid = $object['id'];  if($objtype=='bug'){  $parse_id = explode('_', $object['id']) ;  $objid = $parse_id[0] ;  }  $flag = true;  $tr_id = $object['id'] ;  $tr_class = '' ;  if($objtype=='bug')  $tr_id = 'bug_'.$tr_id ;  if($objtype!='bug'){if((!empty($object['status']) && $this->controller->is_done($object['status']))||(isset($object['status'])&&($object['status']=='done'))){  $tr_class = "rowdone";  }  }  else{if(isset($object['status'])&&(in_array($object['status'],get_bug_wf_ending_status())))$tr_class = "rowdone" ;  }?><tr id="<?php echo $tr_id ;?>" class = "<?php echo $tr_class ; ?>" <?php if($objtype=='task'&&(isset($object['remain']))){ echo "remain='".$object['remain']."'" ;} ?> ><?php foreach($object as $key=>$value):?><?php if(in_array($key,$display_fields)):?><td><?php if(in_array($objtype.'_'.$objid,$son_objects) && $flag):$flag = false;?>&nbsp;&nbsp;<?php if ($objtype=="story"){ $tip = $myHtml->tip_translate(1); ?><span class="tag_story_child" title="<?php echo t($tip['content']) ?>"><i><?php echo $objtype;?></i></span><?php }else { ?><span class="tag_<?php echo $objtype;?>"><i><?php echo $objtype;?></i></span><?php }   elseif($flag):$flag = false;?><?php if ($objtype=="story"){ $tip = $myHtml->tip_translate(1); ?><span class="tag_story_child" title="<?php echo t($tip['content']) ?>"><i><?php echo $objtype;?></i></span><?php }else { ?><span class="tag_<?php echo $objtype;?>"><i><?php echo $objtype ;?></i></span><?php } ?><?php endif;?><?php if( !empty($fields_info) && array_key_exists($key,$fields_info[$objtype])):?><?php $show_type = 0;?><?php if( array_key_exists('linkable',$fields_info[$objtype][$key]) ) : $show_type += LINK_TYPE; endif;?><?php if(array_key_exists('dropable',$fields_info[$objtype][$key])): $show_type += DROP_TYPE; endif;?><?php if(array_key_exists('process_bar',$fields_info[$objtype][$key])): $show_type += PROGRESS_TYPE; endif;?><?php $tmp_fields_info = $fields_info;?><?php if ( LINK_TYPE == $show_type ):?><?php $this->controller->__replace_field_value($tmp_fields_info[$objtype],$objid,$key,'linkable');?><?php $url = $tmp_fields_info[$objtype][$key]['linkable'];?><?php if(($key=='name')&&(isset($object['attachment_count']))&&($object['attachment_count'] > 0)): ?><span title="<?php echo $object['attachment_count'] . ' ' . t('attachments', '/list') ; ?>" class="tapd-btn-attachment"><i><?php echo t('Attachment') ; ?></i></span><?php endif; ?><a <?php if($key == 'name'): echo 'title="'.$value.'" ';endif;?> href="<?php echo $myHtml->url($url);?>" <?php if('bug'==$objtype) echo "target='_blank'"  ?> ><?php if(!empty($object['due']) && (strtotime($object['due'])+86400-time())<0 && $key=='name' && $object['status'] != 'resolved' && $object['status'] != 'done') : if ($objtype=="story") $img_title = t("Notice:the story has been delayed!");else $img_title = t("Notice:the task has been delayed!");echo '<span class="tapd-btn-error" title="'.$img_title.'"><i>error</i></span>' ?><?php echo $value;?><?php else:?><?php if(('bug'==$objtype)&&($key=='id')): $value = explode('_',$value) ;$title = $value[1] ;echo $title ;   else:   echo $value ;   endif ;?><?php endif;?></a><?php elseif ( DROP_TYPE == $show_type ):?><?php $this->controller->__replace_field_value($tmp_fields_info[$objtype],$objid,$key,'dropable');$dropable = $tmp_fields_info[$objtype][$key]['dropable']; $action_manu_options_type = array();$disabled_operations = array() ;if($key=='Action' && $this->controller->is_done($object['status'])) {$action_manu_options_type['split_story'] = "disabled";$action_manu_options_type['split_task'] = "disabled";$action_manu_options_type['timesheet'] = "disabled";$disabled_operations = array('split_story','split_task','timesheet') ;}if($key=='Action' && 'task'==$objtype && 'done'==$object['status']) {$disabled_operations = array('timesheet') ;}?><?php $default = $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id'],$append_fields_info);?><?php if($key=='Action'): ?><?php echo $this->renderElement('op_list',array('entity_type'=>$objtype,'entity_id'=>$objid,'list'=>$operation_list,'disabled_operations'=>$disabled_operations)) ;?><?php else: ?><?php echo $this->renderElement('pop_select',array_merge($dropable, array('id'=>$objtype.'_'.$key.'_'.$objid,'entity_id' => $objid, 'default'=>$default,'options_type'=>$action_manu_options_type)));?><?php endif ; ?><?php elseif ( PROGRESS_TYPE == $show_type ):?><?php if(empty($value)) $progress = 0;$static_array = explode('/',$value);$effort_completed = !empty($static_array[0])?$static_array[0]:0;$effort_total = !empty($static_array[1])?$static_array[1]:0;if($effort_total == 0){$process = 0;}else{$process = round(($effort_completed/$effort_total)*100);}?><?php echo "<div class = 'progress_div'>" ; echo $this->renderElement('process_bar', array('process_bar_percent'=>$process, 'process_bar_width'=>50));echo "</div>" ;?><?php else:?><div title="<?php echo $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id'],$append_fields_info);?>"><?php echo $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id'],$append_fields_info);?></div><?php endif;?><?php else:?><div title="<?php echo $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id'],$append_fields_info);?>"><?php echo $this->controller->__parse_field_value($objtype,$key,$value,$this->controller->workspace['id'],$append_fields_info);?></div><?php endif;?></td><?php endif;?><?php endforeach;?></tr><?php endforeach;?><?php endforeach;?></tbody></table><?php  echo $this->renderElement('pager'); ?><?php }else{ ?><div style="padding:10px;"><?php echo t('No Data', '/prong') ?></div><?php } ?><?php $javascript->link("");?><script>$(document).ready(function(){if(window.page)page();if(window.tb_init){tb_init('a.thickbox, area.thickbox, input.thickbox');//pass where to apply thickboximgLoader = new Image();// preload imageimgLoader.src = tb_pathToImage;}});</script>
